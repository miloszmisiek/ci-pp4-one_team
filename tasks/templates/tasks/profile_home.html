{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid profile-home-container">
    <div class="row text-center">
        <div class="col-12 mx-auto p-2 mt-4 d-flex justify-content-center align-items-center">
            <div class="d-flex flex-column justify-content-center align-items-center p-4">
                <h1>
                    Hello {{ request.user.first_name}} !
                </h1>
                <h3>({{ request.user.get_rank_display}})</h3>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <div class="d-none col-lg-4 p-2 mx-auto mt-4 d-lg-flex justify-content-center justify-content-lg-start">
            <div class="d-flex justify-content-between align-self-center">
                <i class="fas fa-anchor font-weight-bold pr-3 align-self-center"></i> <span class="align-self-center h2 m-auto">What's Next ?</span>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-4 p-2 pl-md-4 pl-lg-2 mx-auto mt-4 h5">
            <form action="" method="get" id="my_form">
                <select onchange="submit_form('my_form')" class="d-flex mx-lg-auto p-3 text-center select-month" name="months" id="months">
                    <option disabled>Select Month</option>
                    <option value='1'>Janaury</option>
                    <option value='2'>February</option>
                    <option value='3'>March</option>
                    <option value='4'>April</option>
                    <option value='5'>May</option>
                    <option value='6'>June</option>
                    <option value='7'>July</option>
                    <option value='8'>August</option>
                    <option value='9'>September</option>
                    <option value='10'>October</option>
                    <option value='11'>November</option>
                    <option value='12'>December</option>
                </select>
            </form>
        </div>
        <div class="col-12 col-md-6 col-lg-4 p-2 pr-md-4 pr-lg-2 h5 mx-auto mt-4">
            <div class="mw-50 w-100 ml-md-auto today-is"><strong>Today is:</strong>
                <div id="date"></div>
            </div>
        </div>
    </div>
    {% if user.rank is not 3 %}
    <div class="row text-right">
        <div class="col-12 mx-auto col-lg-4 mt-4 ml-lg-auto mr-lg-0 px-md-4 px-lg-auto text-center">
            <div class="add-task-btn">
                <a href="{% url 'add_task' %}">Add Task +</a>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="row">
        <div class="col">
            <table class="mx-auto mt-5" id="home-table">
                <thead>
                    <tr class="table-head">
                        <th onclick="sortTable(0)">ID</th>
                        <th onclick="sortTable(1)">Status</th>
                        <th onclick="sortTable(2)">Owner</th>
                        <th onclick="sortTable(3)">Priority</th>
                        <th onclick="sortTable(4)">Title</th>
                        <th onclick="sortTable(5)" id="end-date">
                            End Date <i class="fas fa-caret-up"></i></th>
                        <th onclick="sortTable(6)">Approval</th>
                    </tr>
                </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr class="{% if task.approval_status == 1 %} 
                        approval-styling {% endif %}
                        {% if task.status == 1 %} clr-green {% endif %}
                        {% if task.status != 1 %}
                        {% if task.is_past_due.0%}
                        clr-red font-weight-600
                        {% elif task.is_past_due.1 <= 2 %}
                        clr-warning
                        {% endif %}
                        {% endif %}
                        ">
                            <td>{{ forloop.counter }}</td>
                            <td>
                            {% if task.assigned_to == request.user and request.user.rank == 2 and task.approval_status == 0 or request.user.rank == 1 and task.approval_status != 1 or request.user.is_superuser %}
                                <button class="border-0 bg-transparent m-auto 
                                {% if task.status == 0 and task.is_past_due.1 <= 2 %} 
                                clr-warning tasks-titles p-1
                                {% elif task.status == 1 %} p-0 
                                {% elif task.status == 2 %} 
                                clr-red font-weight-600 tasks-titles p-1
                                {% else %} p-1 tasks-titles 
                                {% endif %}" 
                                data-toggle="modal" data-target="#completeModal" data-title="{{ task.title }}"
                                data-task-status="{{ task.status }}" data-assigned="{{ task.assigned_to }}"
                                data-id="{{ task.id }}" data-username="{{ request.user.username }}"
                                data-user-rank="{{ request.user.rank }}">{% if task.status == 1 %} <i class="fas fa-check-circle complete-functionality clr-green border-0"></i> {% else %} {{ task.get_status_display }} {% endif %}</button>
                            {% else %}
                                {% if task.status == 1 %} <i class="fas fa-check-circle clr-green"></i> {% else %} {{ task.get_status_display }} {% endif %}
                            {% endif %}
                            </td>
                            <td id="task-assigned"><span class="assigned-rank">{{ task.assigned_to.get_rank_display }}</span><span class="assigned-username">{{ task.assigned_to }}</span></td>
                            <td>{{ task.get_priority_display }}</td>
                            
                            <td class="btn-title" data-toggle="modal"
                            data-target="#exampleModal" data-title="{{ task.title }}"
                            data-description="{{ task.description }}" data-assigned="{{ task.assigned_to }}"
                            data-id="{{ task.id }}" data-username="{{ request.user.username }}"
                            data-user-rank="{{ request.user.rank }}" data-created-on="{{ task.created_on | date:'d F Y' }}"
                            data-updated-on="{{ task.updated_on | date:'d F Y' }}" data-start-date="{{ task.start_date | date:'d F Y' }}"
                            data-end-date="{{ task.end_date | date:'d F Y' }}" data-duration="{{ task.duration }}">
                            <button class="
                            {% if task.status == 1 %} clr-green {% endif %}
                            {% if task.status != 1 %}
                            {% if task.is_past_due.0%}
                            clr-red font-weight-600
                            {% elif task.is_past_due.1 <= 2 %}
                            clr-warning
                            {% endif %}
                            {% endif %}
                            border-0 bg-transparent m-auto p-1 tasks-titles font-weight-600">{{ task.title }}</button>
                            </td>

                            <td>{% if task.status != 1 %}{% if task.is_past_due.0 %}<i class="fas fa-exclamation pr-1"></i>{% elif task.is_past_due.1 <= 2 %} <i class="fas fa-exclamation-triangle clr-warning pr-1"></i> {% endif %}{% endif %} {{ task.end_date | date:"d F Y" }}</td>
                            <td>
                            {% if task.approval_status != 2 %}
                                {% if request.user.is_superuser or request.user.rank == 1 and task.priority != 0 %}
                                            <a href="{% url 'approve' task.id %}">
                                                {% if task.approval_status == 1 %}
                                                <button type="button" class="btn btn-success approve-btn" data-id="{{ task.id }}"
                                                    data-approval="{{ task.approval_status }}">Approve</button>
                                                {% else %} 
                                                <button type="button" class="border-0 bg-transparent m-auto p-1 tasks-titles" data-id="{{ task.id }}"
                                                    data-approval="{{ task.approval_status }}">{{ task.get_approval_status_display }}</button>
                                                {% endif %}
                                            </a>
                                            <input type="hidden" name="approve-request" />
                                {% else %}
                                    {% if task.approval_status == 1 %} <i class="fas fa-clock"></i> {% endif %}
                                    {{ task.get_approval_status_display }}
                                {% endif %} 
                            {% else %}
                                {{ task.get_approval_status_display }}
                            {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
            </table>
        </div>
    </div>
    <div class="row text-right clear-completed-row">
        <div class="col-12 mx-auto col-sm-4 mb-5 mt-md-4 mt-lg-5 ml-sm-auto mr-sm-0 pr-0 pr-md-4 pr-lg-2 text-center">
            <form action="" method="post">
                {% csrf_token %}
                <button class="add-task-btn mr-sm-0 border-0" type="submit">Hide Completed</button>
                <input type="hidden" name="hide-completed" />
            </form>
        </div>
    </div>

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                </div>
                <div class="details-dates container p-2">
                    <div class="row w-100 mx-auto py-sm-2">
                        <div class="col-12 col-sm-6 mx-auto text-lg-center px-0 extra-dates"><span class="p-1"><strong>Created On:</strong> <span id="created-on-modal"></span></span></div>
                        <div class="col-12 col-sm-6 mx-auto text-lg-center px-0 "><span class="p-1"><strong>Updated On:</strong> <span id="updated-on-modal"></span></span></div>
                    </div>
                    <div class="row w-100 mx-auto py-sm-2">
                        <div class="col-12 col-sm-6 col-lg-4 mx-auto text-lg-center px-0 priority-dates"><span class="p-1"><strong>Start Date:</strong> <span id="start-date-modal"></span></span></div>
                        <div class="col-12 col-sm-6 col-lg-4 mx-auto text-lg-center px-0 priority-dates"><span class="p-1"><strong>End Date:</strong> <span id="end-date-modal"></span></span></div>
                        <div class="col-12 col-sm-6 col-lg-4 mr-auto text-lg-center pt-sm-3 pt-lg-0 px-0 priority-dates"><span class="p-1"><strong>Duration:</strong> <span id="duration-modal"></span></span></div>
                    </div>
                </div>
                {% if user.rank != 3 %}
                <div class="description-buttons d-flex justify-content-around p-2">
                    <a id="edit-task-anchor" href="#">
                        <button type="button" class="btn btn-warning">Edit Task</button>
                    </a>
                    <a id="delete-task-anchor" class="confirm-delete" href="">
                        <button type="button" class="btn btn-danger">Delete Task</button>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="modal fade" id="completeModal" tabindex="-1" role="dialog" aria-labelledby="completeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
            </div>
            <div class="description-buttons d-flex justify-content-around p-2">
                <a id="yes-anchor" href="#">
                    <button type="button" class="btn btn-warning">Yes</button>
                </a>
                <a id="no-anchor" href="">
                    <button type="button" class="btn btn-danger">No</button>
                </a>
            </div>
        </div>
    </div>
    </div>
</div>

{% endblock %}

{% block postloadjs %}
<script src="{% static 'js/profile_home.js' %}"></script>
{% endblock%}